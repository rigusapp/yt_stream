<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>YT Stream — Professional</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

<!-- TAMBAHAN SAJA -->
<script src="auth.js"></script>

<style>
/* === CSS ANDA (TIDAK DIUBAH) === */
body{font-family:'Inter',sans-serif;background:#f4f7fb;margin:0;color:#0f172a}
.container{max-width:980px;margin:36px auto;padding:28px;background:white;border-radius:12px;box-shadow:0 8px 30px rgba(16,24,40,.06)}
.nav{margin-top:20px;display:flex;gap:30px;border-bottom:1px solid #e5e7eb;padding-bottom:12px}
.nav-item{font-size:15px;font-weight:600;text-decoration:none;color:#1f2937;padding-bottom:6px;border-bottom:2px solid transparent}
.nav-item.active{color:#2563eb;border-color:#2563eb}
.card{background:white;padding:20px;border-radius:10px;border:1px solid #e5e7eb;margin-top:24px}
label{display:block;font-weight:600;margin-bottom:6px;font-size:13px}
.input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb}
textarea{min-height:110px}
.btn{padding:10px 14px;background:#2563eb;color:white;border-radius:10px;border:0;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;color:#2563eb;border:1px solid #dbeafe}
.debug{background:#0b1220;color:#bfe7b0;padding:12px;border-radius:8px;font-family:monospace;display:none}
.footer{margin-top:24px;color:#6b7280;font-size:13px}
.form-row{display:flex;gap:24px;margin-bottom:20px}
.form-col{flex:1;display:flex;flex-direction:column}
@media(max-width:700px){.form-row{flex-direction:column}}
</style>
</head>

<body>
<div class="container">

<h1>YT Stream — Professional</h1>
<p style="margin:6px 0 0;color:#6b7280;">Dashboard profesional untuk livestream YouTube</p>

<div class="nav">
    <a href="dashboard.html" class="nav-item">Dashboard</a>
    <a href="penyimpanan.html" class="nav-item">Penyimpanan</a>
    <a href="jadwal.html" class="nav-item">Jadwal Live</a>
    <a href="monitoring.html" class="nav-item">Monitoring</a>
    <a href="pengaturan.html" class="nav-item">Pengaturan</a>

    <!-- TAMBAHAN SAJA -->
    <a href="#" onclick="logout()" class="nav-item"
       style="margin-left:auto;color:#e11d48;">Logout</a>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
    const cur = location.pathname.split("/").pop();
    document.querySelectorAll(".nav-item").forEach(a=>{
        if(a.getAttribute("href")===cur) a.classList.add("active");
    });
});
</script>

<!-- ========================= -->
<!--          FORM             -->
<!-- ========================= -->

<div class="card">

<div class="form-row">
  <div class="form-col">
    <label>Judul</label>
    <input id="inp_title" class="input">
  </div>
  <div class="form-col">
    <label>Visibilitas</label>
    <select id="inp_vis" class="input">
      <option value="public">Publik</option>
      <option value="unlisted">Tidak Publik</option>
      <option value="private">Pribadi</option>
    </select>
  </div>
</div>

<label>Description</label>
<textarea id="inp_desc" class="input"></textarea>

<div class="form-row">
  <div class="form-col">
    <label>Tanggal & Jam Live (WIB)</label>
    <input id="inp_time" class="input">
  </div>
  <div class="form-col">
    <label>Durasi</label>
    <select id="inp_dur" class="input">
      <option value="300" selected>5 menit</option>
      <option value="600">10 menit</option>
      <option value="1200">20 menit</option>
      <option value="1800">30 menit</option>
      <option value="2400">40 menit</option>
      <option value="3000">50 menit</option>
      <option value="3600">1 Jam</option>
      <option value="7200">2 Jam</option>
    </select>
  </div>
  <div class="form-col" style="justify-content:flex-end">
    <label><input type="checkbox" id="inp_loop"> Loop Video</label>
  </div>
</div>

<label>Sumber Video</label>
<select id="video_source" class="input">
    <option value="url">Video URL Manual</option>
    <option value="gdrive">Google Drive</option>
    <option value="storage">Penyimpanan</option>
</select>

<div id="box_manual">
    <label>Video URL</label>
    <input id="inp_video" class="input" placeholder="https://website.com/video.mp4">
</div>

<div id="gdrive_box" style="display:none;">
    <label>Google Drive Link</label>
    <input id="inp_gdrive" class="input" placeholder="https://drive.google.com/file/d/...">
</div>

<div id="storage_box" style="display:none;">
    <label>Pilih Video dari Penyimpanan</label>
    <select id="inp_storage" class="input">
        <option value="">Memuat...</option>
    </select>
</div>

<label>Stream Key</label>
<input id="inp_key" class="input">

<div style="display:flex;gap:10px;margin-top:14px;">
    <button id="btn_trigger" class="btn">Stream Now</button>
    <button id="btn_clear" class="btn ghost">Clear</button>
</div>

</div>

<!-- ========================= -->
<!--         LOG AREA          -->
<!-- ========================= -->

<div class="card">
<h3>Preview & Log</h3>
<pre id="payload" class="debug"></pre>
<div id="log" class="debug"></div>
</div>

<div class="footer">Built for you — Buana Media</div>

</div>

<script>
function toISO_WIB(str){
    if(!str) return "";
    let [d,m,y] = str.split(" ")[0].split("/");
    let time = str.split(" ")[1];
    return `${y}-${m}-${d}T${time}:00+07:00`;
}

const srcSelect = document.getElementById("video_source");
const box_manual = document.getElementById("box_manual");
const boxGDrive = document.getElementById("gdrive_box");
const boxStorage = document.getElementById("storage_box");

srcSelect.onchange = () => {
    const v = srcSelect.value;
    box_manual.style.display = "none";
    boxGDrive.style.display = "none";
    boxStorage.style.display = "none";

    if(v === "url") box_manual.style.display = "block";
    else if(v === "gdrive") boxGDrive.style.display = "block";
    else if(v === "storage") {
        boxStorage.style.display = "block";
        loadStorageVideos();
    }
};

async function loadStorageVideos(){
    inp_storage.innerHTML = `<option>Memuat...</option>`;
    const r = await fetch("https://yt-scheduler-api.rigus-apps.workers.dev/storage");
    const j = await r.json();

    inp_storage.innerHTML = `<option value="">-- Pilih Video --</option>`;
    j.list.forEach(item=>{
        const url = "https://yt-scheduler-api.rigus-apps.workers.dev/public/" + item.key;
        inp_storage.innerHTML += `<option value="${url}">${item.key}</option>`;
    });
}

function convertDriveLink(url){
    const match = url.match(/\/d\/(.*?)\//);
    if(!match) return "";
    return `https://drive.google.com/uc?export=download&id=${match[1]}`;
}

btn_clear.onclick = ()=>{
    inp_title.value = "";
    inp_desc.value = "";
    inp_video.value = "";
    inp_key.value = "";
    inp_vis.value = "public";
    inp_gdrive.value = "";
    payload.style.display = "none";
    log.style.display = "none";
};

async function postJSON(url, body){
    const res = await fetch(url,{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(body)
    });
    return {ok:res.ok,status:res.status,text:await res.text()};
}

btn_trigger.onclick = async ()=>{

    let finalVideo = "";
    if(srcSelect.value === "url") finalVideo = inp_video.value.trim();
    else if(srcSelect.value === "gdrive") finalVideo = convertDriveLink(inp_gdrive.value.trim());
    else if(srcSelect.value === "storage") finalVideo = inp_storage.value.trim();

    const payloadData = {
        title: inp_title.value.trim(),
        description: inp_desc.value.trim(),
        visibility: inp_vis.value,
        video_url: finalVideo,
        stream_key: inp_key.value.trim(),
        start_time: toISO_WIB(inp_time.value),
        duration_seconds: Number(inp_dur.value),
        looping: inp_loop.checked,
        rtmp_url:"rtmp://a.rtmp.youtube.com/live2"
    };

    payload.style.display = "block";
    payload.textContent = JSON.stringify(
        {...payloadData, stream_key:"*****MASKED*****"},
        null,2
    );

    log.style.display = "block";
    log.textContent = "Sending...";

    await fetch("https://yt-scheduler-api.rigus-apps.workers.dev/schedule",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payloadData)
    });

    const r = await postJSON(
        "https://ytstream-proxy.rigus-apps.workers.dev/",
        { event_type:"stream_trigger", client_payload:payloadData }
    );

    log.textContent = "Worker response: "+r.status+"\n"+r.text;
};
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<script>
flatpickr("#inp_time",{
    enableTime: true,
    dateFormat: "d/m/Y H:i",
    time_24hr: true,

    // ⬇️ TIDAK mengisi tanggal
    defaultDate: null,

    // ⬇️ Jam otomatis = jam sekarang
    defaultHour: new Date().getHours(),
    defaultMinute: new Date().getMinutes(),

    // ⬇️ Setiap kali picker dibuka, jam di-refresh ke waktu sekarang
    onOpen: function(selectedDates, dateStr, instance){
        const now = new Date();
        instance.setDate(
            instance.selectedDates[0] || now,
            false
        );
        instance.setTime(now.getHours(), now.getMinutes());
    }
});
</script>


</body>
</html>
