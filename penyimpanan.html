<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Penyimpanan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  background:#f4f7fb;
  margin:0;
  padding:0;
  color:#0f172a;
}

.container{
  max-width:980px;
  margin:36px auto;
  padding:28px;
  background:white;
  border-radius:12px;
  box-shadow:0 8px 30px rgba(16,24,40,0.06);
}

/* NAVBAR */
.nav{
  margin-top:20px;
  display:flex;
  gap:30px;
  border-bottom:1px solid #e5e7eb;
  padding-bottom:12px;
}

.nav-item{
  font-size:15px;
  font-weight:600;
  text-decoration:none;
  color:#1f2937;
  padding-bottom:6px;
  border-bottom:2px solid transparent;
  transition:all .15s ease;
}

.nav-item:hover{
  color:#2563eb;
}

.nav-item.active{
  color:#2563eb;
  border-color:#2563eb;
}

/* Card */
.card{
  background:white;
  padding:24px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  margin-top:24px;
}

/* Buttons */
.btn{
  padding:10px 18px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  border:0;
  font-size:15px;
}
.btn.blue{ background:#2563eb; color:white; }
.btn.red{ background:#e11d48; color:white; }
.btn.gray{ background:#e5e7eb; color:#1f2937; }

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

table th, table td {
  padding:12px 10px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
}

table th {
  font-weight:700;
  font-size:15px;
  color:#1f2937;
}

table tr:last-child td{
  border-bottom:none;
}

.small{
  color:#6b7280;
  font-size:14px;
}
</style>
</head>

<body>

<div class="container">

  <h1 style="margin:0;">Penyimpanan</h1>
  <p style="margin:6px 0 0; color:#6b7280;">Halaman untuk mengelola data tersimpan.</p>

  <!-- NAVBAR -->
  <div class="nav">
    <a href="index.html" class="nav-item">Dashboard</a>
    <a href="penyimpanan.html" class="nav-item">Penyimpanan</a>
    <a href="jadwal.html" class="nav-item">Jadwal Live</a>
    <a href="monitoring.html" class="nav-item">Monitoring</a>
    <a href="pengaturan.html" class="nav-item">Pengaturan</a>
  </div>

  <!-- Auto Active -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const current = location.pathname.split("/").pop();
    document.querySelectorAll(".nav-item").forEach(nav => {
      if(nav.getAttribute("href") === current){
        nav.classList.add("active");
      }
    });
  });
  </script>

  <!-- Card Penyimpanan -->
  <div class="card">
    
    <h3 style="margin:0 0 10px;">Upload File ke Cloudflare R2</h3>
    <hr style="margin:18px 0; border:0; border-top:1px solid #e5e7eb;">

    <!-- Input file -->
    <input id="fileInput" type="file" style="margin-bottom:10px;">

    <!-- Buttons -->
    <div style="display:flex; gap:10px; margin-top:5px; margin-bottom:15px;">
      <button id="uploadBtn" class="btn blue">Upload</button>
      <button id="refreshBtn" class="btn gray">Refresh</button>
    </div>

    <p id="uploadStatus" class="small"></p>

    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th>Nama File</th>
          <th>Ukuran</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="storageTbody">
        <tr><td colspan="3" class="small">Memuat...</td></tr>
      </tbody>
    </table>

  </div>

</div>

<script>
const API = "https://yt-scheduler-api.rigus-apps.workers.dev";

//
// LIST FILES
//
async function loadFiles() {
  const tbody = document.getElementById("storageTbody");
  tbody.innerHTML = `<tr><td colspan="3" class="small">Memuat...</td></tr>`;

  try {
    const r = await fetch(API + "/storage");
    const j = await r.json();
    if (!j.ok) {
      tbody.innerHTML = `<tr><td colspan="3" class="small">Gagal memuat data</td></tr>`;
      return;
    }

    if (j.list.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" class="small">Belum ada file tersimpan</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    j.list.forEach(item => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${item.key}</td>
        <td>${Math.round(item.size / 1024)} KB</td>
        <td>
          <button class="btn gray" style="padding:6px 12px;"
        onclick="copyLink('${item.key}')">Copy</button>
<button class="btn red" style="padding:6px 12px;"
        onclick="deleteFile('${item.key}')">Hapus</button>

        </td>
      `;

      tbody.appendChild(tr);
    });
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="3" class="small">Error: ${err}</td></tr>`;
  }
}

//
// UPLOAD
//
document.getElementById("uploadBtn").onclick = async () => {
  const fileEl = document.getElementById("fileInput");
  const status = document.getElementById("uploadStatus");

  if (!fileEl.files[0]) {
    status.textContent = "Pilih file terlebih dahulu.";
    return;
  }

  const fd = new FormData();
  fd.append("file", fileEl.files[0]);

  status.textContent = "Uploading...";

  try {
    const r = await fetch(API + "/upload", {
      method: "POST",
      body: fd
    });

    const j = await r.json();

    if (j.ok) {
      status.textContent = "Upload berhasil: " + j.key;
      fileEl.value = "";
      loadFiles();
    } else {
      status.textContent = "Upload gagal: " + j.error;
    }
  } catch (err) {
    status.textContent = "Error upload: " + err;
  }
};

//
// DELETE
//
async function deleteFile(key) {
  if (!confirm("Hapus file " + key + " ?")) return;

  try {
    const r = await fetch(API + "/storage/" + key, { method: "DELETE" });
    const j = await r.json();
    if (j.ok) {
      loadFiles();
    } else {
      alert("Gagal menghapus: " + j.error);
    }
  } catch (err) {
    alert("Error: " + err);
  }
}

//
// COPY LINK
//
function copyLink(key) {
  const url = API + "/storage/" + key;
  navigator.clipboard.writeText(url)
    .then(() => alert("Link disalin:\n" + url))
    .catch(err => alert("Gagal menyalin: " + err));
}

  
// Refresh
document.getElementById("refreshBtn").onclick = loadFiles;

// Auto load
loadFiles();
</script>

</body>
</html>
