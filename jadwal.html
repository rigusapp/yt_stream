<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Jadwal Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  background:#f4f7fb;
  margin:0;
  padding:0;
  color:#0f172a;
}

.container{
  max-width:980px;
  margin:36px auto;
  padding:28px;
  background:white;
  border-radius:12px;
  box-shadow:0 8px 30px rgba(16,24,40,0.06);
}

/* NAVBAR */
.nav{
  margin-top:20px;
  display:flex;
  gap:30px;
  border-bottom:1px solid #e5e7eb;
  padding-bottom:12px;
}

.nav-item{
  font-size:15px;
  font-weight:600;
  text-decoration:none;
  color:#1f2937;
  padding-bottom:6px;
  border-bottom:2px solid transparent;
  transition:all .15s ease;
}

.nav-item:hover{ color:#2563eb; }
.nav-item.active{
  color:#2563eb;
  border-color:#2563eb;
}

.card{
  background:white;
  padding:20px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  margin-top:24px;
}

.btn{
  padding:8px 12px;
  border-radius:8px;
  background:#2563eb;
  color:white;
  font-size:14px;
  border:0;
  cursor:pointer;
  font-weight:600;
}

.btn.ghost{
  background:#f0f4ff;
  color:#2563eb;
  border:1px solid #dbeafe;
}

.small{ font-size:13px; color:#6b7280; }

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}

th, td{
  padding:12px;
  font-size:14px;
  border-bottom:1px solid #e5e7eb;
}

th{
  text-align:left;
  font-weight:600;
}

.tag{
  display:inline-block;
  padding:4px 9px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  margin-left:6px;
}

.tag-upcoming{ background:#e0f2fe; color:#0369a1; }
.tag-live{ background:#fee2e2; color:#b91c1c; }
.tag-done{ background:#e5e7eb; color:#4b5563; }

</style>
</head>

<body>

<div class="container">

  <h1 style="margin:0;">Jadwal Live</h1>
  <p style="margin:6px 0 0; color:#6b7280;">Halaman untuk melihat jadwal livestream.</p>

  <!-- NAVBAR -->
  <div class="nav">
    <a href="index.html" class="nav-item">Dashboard</a>
    <a href="penyimpanan.html" class="nav-item">Penyimpanan</a>
    <a href="jadwal.html" class="nav-item">Jadwal Live</a>
    <a href="monitoring.html" class="nav-item">Monitoring</a>
    <a href="pengaturan.html" class="nav-item">Pengaturan</a>
  </div>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const current = location.pathname.split("/").pop();
  document.querySelectorAll(".nav-item").forEach(nav=>{
    if(nav.getAttribute("href") === current){
      nav.classList.add("active");
    }
  });
});
</script>

<div class="card">

  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <!-- Tombol Tambah Dihilangkan -->
      <button id="btnSync" class="btn ghost">Sync Now</button>
    </div>
    <div class="small" id="status">â€”</div>
  </div>

  <div style="margin-top:12px;overflow:auto">
    <table>
      <thead>
        <tr>
          <th>Waktu (WIB)</th>
          <th>Judul</th>
          <th>Durasi</th>
          <th>Video</th>
          <th style="text-align:right">Aksi</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="5" class="small">Memuat...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/* WORKER URL */
const WORKER_URL = "https://yt-scheduler-api.rigus-apps.workers.dev";

const api = (path, opts={}) =>
  fetch(WORKER_URL + path, Object.assign({
    headers: { "Content-Type": "application/json" }
  }, opts));

const $ = id => document.getElementById(id);

async function loadList(){
  $("status").textContent = "Memuat jadwal...";
  try {
    const r = await api("/schedule");
    const j = await r.json();
    if(!j.ok){ throw new Error(j.error || "Gagal mengambil data"); }
    renderTable(j.list || []);
    $("status").textContent = "Terakhir: " + new Date().toLocaleString();
  } catch(err) {
    $("status").textContent = "Error: " + err.message;
    renderTable([]);
  }
}

function escapeHtml(s){
  if(!s) return "";
  return String(s).replace(/[&<>"']/g, (m)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

function renderTable(list){
  const tbody = $("tbody");

  if(!list.length){
    tbody.innerHTML = '<tr><td colspan="5" class="small">Belum ada jadwal.</td></tr>';
    return;
  }

  list.sort((a,b)=> new Date(a.start_time) - new Date(b.start_time));

  const now = Date.now();
  tbody.innerHTML = "";

  for(const item of list){
    const start = new Date(item.start_time);
    const end = new Date(start.getTime() + (item.duration_seconds*1000));

    let tag = "";
    if(now < start){
      if(start - now < 3600*1000){
        tag = `<span class="tag tag-upcoming">Sebentar lagi</span>`;
      }
    } else if(now >= start && now <= end){
      tag = `<span class="tag tag-live">Sedang Live</span>`;
    } else {
      tag = `<span class="tag tag-done">Selesai</span>`;
    }

    const dur = Math.floor((item.duration_seconds||0)/60) + "m";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${start.toLocaleString()} ${tag}</td>
      <td><strong>${escapeHtml(item.title)}</strong><div class="small">${escapeHtml(item.description||"")}</div></td>
      <td>${dur}</td>
      <td class="small">${escapeHtml(item.video_url||"")}</td>
      <td style="text-align:right">
        <button class="btn ghost" onclick="gotoEdit('${item.id}')">Edit</button>
        <button class="btn" onclick="delItem('${item.id}')">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function gotoEdit(id){
  alert("Edit dilakukan dari Dashboard.\nSilakan buka Dashboard dan ubah jadwal di sana.");
}

async function delItem(id){
  if(!confirm("Hapus jadwal ini?")) return;
  try {
    const r = await api("/schedule/" + id, { method:"DELETE" });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error);
    loadList();
  } catch(e){
    alert("Error: " + e.message);
  }
}

$("btnSync").onclick = () => loadList();

loadList();
</script>

</div>

</body>
</html>
