<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Jadwal Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  background:#f4f7fb;
  margin:0;
  padding:0;
  color:#0f172a;
}

.container{
  max-width:980px;
  margin:36px auto;
  padding:28px;
  background:white;
  border-radius:12px;
  box-shadow:0 8px 30px rgba(16,24,40,0.06);
}

/* NAVBAR */
.nav{
  margin-top:20px;
  display:flex;
  gap:30px;
  border-bottom:1px solid #e5e7eb;
  padding-bottom:12px;
}

.nav-item{
  font-size:15px;
  font-weight:600;
  text-decoration:none;
  color:#1f2937;
  padding-bottom:6px;
  border-bottom:2px solid transparent;
  transition:all .15s ease;
}

.nav-item:hover{
  color:#2563eb;
}

.nav-item.active{
  color:#2563eb;
  border-color:#2563eb;
}

.card{
  background:white;
  padding:20px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  margin-top:24px;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:12px 10px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
}

.small{ font-size:13px; color:#6b7280; }

.btn{
  padding:8px 14px;
  border-radius:8px;
  border:0;
  cursor:pointer;
  font-weight:600;
}

.btn.ghost{
  background:#eff6ff;
  color:#2563eb;
}

.btn.danger{
  background:#dc2626;
  color:white;
}
</style>
</head>

<body>

<div class="container">

  <h1 style="margin:0;">Jadwal Live</h1>
  <p style="margin:6px 0 0; color:#6b7280;">Halaman untuk melihat jadwal livestream.</p>

  <!-- NAVBAR -->
  <div class="nav">
    <a href="index.html" class="nav-item">Dashboard</a>
    <a href="penyimpanan.html" class="nav-item">Penyimpanan</a>
    <a href="jadwal.html" class="nav-item">Jadwal Live</a>
    <a href="monitoring.html" class="nav-item">Monitoring</a>
    <a href="pengaturan.html" class="nav-item">Pengaturan</a>
  </div>

  <!-- AUTO ACTIVE -->
  <script>
  document.addEventListener("DOMContentLoaded", ()=>{
    const current = location.pathname.split("/").pop();
    document.querySelectorAll(".nav-item").forEach(nav=>{
      if(nav.getAttribute("href") === current){
        nav.classList.add("active");
      }
    });
  });
  </script>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <button id="btnSync" class="btn ghost">Sync Now</button>
      <div id="status" class="small">â€”</div>
    </div>

    <div style="margin-top:12px;overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Waktu (WIB)</th>
            <th>Judul</th>
            <th>Durasi</th>
            <th>Video</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="small">Memuat...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>


<!-- SCRIPT -->
<script>
const WORKER_URL = "https://yt-scheduler-api.rigus-apps.workers.dev";
const $ = id => document.getElementById(id);

async function loadList(){
  $("status").textContent = "Memuat jadwal...";
  try {
    const r = await fetch(WORKER_URL + "/schedule");
    const j = await r.json();
    if(!j.ok) throw new Error(j.error);
    renderTable(j.list || []);
    $("status").textContent = "Terakhir: " + new Date().toLocaleString();
  } catch(err) {
    $("status").textContent = "Error: "+err.message;
  }
}

function escapeHtml(s){
  if(!s) return "";
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

/* ============ RENDER TABLE ============ */
function renderTable(list){
  const tbody = $("tbody");
  if(list.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" class="small">Belum ada jadwal.</td></tr>';
    return;
  }

  list.sort((a,b)=> new Date(a.start_time) - new Date(b.start_time));
  tbody.innerHTML = "";
  const now = Date.now();

  for(const item of list){
    const startUTC = new Date(item.start_time);
    const startWIB = new Date(startUTC.getTime() + 7*3600*1000);

    const end = new Date(startUTC.getTime() + (item.duration_seconds * 1000));
    const isFinished = now > end;

    const durMin = Math.floor(item.duration_seconds / 60);

    let tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${startWIB.toLocaleString("id-ID")}</td>

      <td>
        <strong>${escapeHtml(item.title)}</strong>
        <div class="small">${escapeHtml(item.description || "")}</div>
      </td>

      <td>${durMin}m</td>

      <td class="small">${escapeHtml(item.video_url)}</td>

      <td style="text-align:right">
        ${
          isFinished
          ? `<button class="btn ghost" data-copy="${item.id}">Copy Stream</button>`
          : `<span class="small" style="opacity:.5">Belum selesai</span>`
        }
        <button class="btn danger" data-del="${item.id}">Hapus</button>
      </td>
    `;

    tbody.appendChild(tr);
  }

  /* EVENT COPY */
  tbody.querySelectorAll("button[data-copy]").forEach(btn=>{
    btn.onclick = ()=> copyData(btn.dataset.copy);
  });

  /* EVENT DELETE */
  tbody.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick = ()=> delItem(btn.dataset.del);
  });
}

/* ============ COPY STREAM DATA ============ */
async function copyData(id){
  try{
    const res = await fetch(WORKER_URL + "/schedule");
    const json = await res.json();
    const item = json.list.find(x => x.id === id);
    if(!item){ alert("Data tidak ditemukan"); return; }

    const dt = new Date(item.start_time);
    const wib = new Date(dt.getTime() + 7*3600*1000);

    const text =
`Judul : ${item.title}
Deskripsi : ${item.description || "-"}
Mulai : ${wib.toLocaleString("id-ID")} WIB
Durasi : ${Math.floor(item.duration_seconds/60)} menit
Video : ${item.video_url}
Visibility : ${item.visibility || "public"}
Looping : ${item.looping ? "Ya" : "Tidak"}
Stream Key : ${item.stream_key}`;

    await navigator.clipboard.writeText(text);
    alert("Berhasil disalin!");
  }catch(e){
    alert("Gagal menyalin: "+e.message);
  }
}

/* ============ DELETE ITEM ============ */
async function delItem(id){
  if(!confirm("Hapus jadwal ini?")) return;

  const r = await fetch(WORKER_URL + "/schedule/" + id, { method: "DELETE" });
  const j = await r.json();

  if(!j.ok){
    alert("Gagal hapus.");
    return;
  }
  loadList();
}

$("btnSync").onclick = ()=> loadList();

/* INITIAL LOAD */
loadList();
</script>

</body>
</html>
