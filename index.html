<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>Dashboard Stream v8 (Proxy GH_PAT)</title>
<style>
body{font-family:Arial,system-ui;margin:20px auto;max-width:820px;padding:12px}
h2{margin-bottom:6px}
label{display:block;margin-top:12px;font-weight:600}
input, select, button, textarea{width:100%;padding:10px;margin-top:6px;font-size:15px}
button{cursor:pointer}
.note{font-size:13px;color:#444;margin-top:8px}
.success{color:green}
.error{color:#b00020;white-space:pre-wrap}
</style>
</head>
<body>
<h2>Dashboard Stream v8 — Secure (Proxy GH_PAT)</h2>
<p class="note">Dashboard ini <strong>tidak</strong> meminta token. Pastikan repo bersifat <strong>public</strong> dan secret <code>GH_PAT</code> sudah disimpan di Settings → Secrets → Actions.</p>

<label>Repository (owner/repo)</label>
<input id="repo" placeholder="contoh: rigusapp/yt_stream" value="rigusapp/yt_stream"/>

<label>Video URL</label>
<input id="video" placeholder="https://.../video.mp4"/>

<label>Tanggal & Jam Live (WIB)</label>
<input id="datetime" type="datetime-local"/>

<label>Durasi</label>
<select id="duration">
  <option value="1800">30 Menit</option>
  <option value="3600" selected>1 Jam</option>
  <option value="7200">2 Jam</option>
  <option value="10800">3 Jam</option>
  <option value="14400">4 Jam</option>
  <option value="18000">5 Jam</option>
  <option value="21600">6 Jam</option>
  <option value="25200">7 Jam</option>
  <option value="28800">8 Jam</option>
  <option value="32400">9 Jam</option>
  <option value="36000">10 Jam</option>
  <option value="39600">11 Jam</option>
  <option value="43200">12 Jam</option>
</select>

<label><input type="checkbox" id="seamless"/> Seamless Loop (tanpa putus)</label>

<button id="startBtn">Trigger Stream (via Proxy)</button>

<div id="log" style="margin-top:14px"></div>

<script>
// Convert datetime-local (local browser) interpreted as local WIB by user -> convert to UTC by subtracting 7 hours
function convertWIBToUTC(datetimeLocal){
    // datetimeLocal is like "2025-12-01T21:30"
    const local = new Date(datetimeLocal);
    const utc = new Date(local.getTime() - (7*60*60*1000));
    return utc.toISOString().split('.')[0] + "Z";
}

async function callAPI(url, opts){
  const res = await fetch(url, opts);
  const text = await res.text();
  let ok = res.ok;
  let json = null;
  try{ json = JSON.parse(text); } catch(e){}
  return {ok, status: res.status, text, json};
}

document.getElementById('startBtn').addEventListener('click', async ()=>{
  const repo = document.getElementById('repo').value.trim();
  const video = document.getElementById('video').value.trim();
  const datetime = document.getElementById('datetime').value.trim();
  const duration = document.getElementById('duration').value;
  const seamless = document.getElementById('seamless').checked;
  const log = document.getElementById('log');

  if(!repo || !video || !datetime){
    alert('Lengkapi repo, video, dan tanggal/waktu.');
    return;
  }
  const utc = convertWIBToUTC(datetime);
  const body = {
    ref: "main",
    inputs: {
      video_url: video,
      start_time: utc,
      duration_seconds: String(duration),
      seamless: seamless ? "true" : "false"
    }
  };

  // dispatch proxy workflow (no auth required for public repo)
  const url = `https://api.github.com/repos/${repo}/actions/workflows/proxy.yml/dispatches`;
  log.innerHTML = '<p>Memanggil proxy workflow…</p>';

  const r = await callAPI(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/vnd.github.v3+json' },
    body: JSON.stringify(body)
  });

  if(r.ok || r.status===204){
    log.innerHTML = '<p class="success">Proxy dispatched — workflow akan memicu streaming. Cek tab Actions di GitHub.</p>';
  } else {
    log.innerHTML = '<div class="error">Gagal dispatch proxy. Status: '+r.status+'\nResponse: '+r.text+'</div>';
  }
});
</script>
</body>
</html>
