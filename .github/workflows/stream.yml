name: Stream to YouTube (FFmpeg Seamless Loop)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [stream_trigger]

jobs:
  stream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Show Payload
        run: |
          echo "=== RAW PAYLOAD ==="
          echo '${{ toJson(github.event.client_payload) }}'
          echo "=== STREAM_KEY ==="
          echo "${{ github.event.client_payload.stream_key }}"

 - name: Stream to YouTube
  run: |
    RTMP="${{ github.event.client_payload.rtmp_url }}/${{ github.event.client_payload.stream_key }}"
    ffmpeg -re -i "${{ github.event.client_payload.video_url }}" \
    -c:v libx264 -preset veryfast -b:v 4500k \
    -c:a aac -b:a 128k -f flv "$RTMP"
