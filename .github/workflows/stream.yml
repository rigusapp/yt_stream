name: Stream to YouTube (FFmpeg Seamless Loop)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [stream_trigger]

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Show Payload
        run: |
          echo "=== VIDEO_URL ==="
          echo "${{ github.event.client_payload.video_url }}"
          echo "=== STREAM_KEY ==="
          echo "${{ github.event.client_payload.stream_key }}"
          echo "=== TITLE ==="
          echo "${{ github.event.client_payload.title }}"
          echo "=== DESC ==="
          echo "${{ github.event.client_payload.description }}"
          echo "===== RAW PAYLOAD ====="
          echo '${{ toJson(github.event.client_payload) }}'

      - name: Start Stream
        run: |
          VIDEO="${{ github.event.client_payload.video_url }}"
          RTMP="${{ github.event.client_payload.rtmp_url }}"
          KEY="${{ github.event.client_payload.stream_key }}"

          echo "=== RUN STREAM ==="
          echo "RTMP: $RTMP"
          echo "KEY:  $KEY"

          if [ -z "$KEY" ]; then
            echo "ERROR: Stream key is EMPTY. Aborting."
            exit 1
          fi

          FULL_URL="$RTMP/$KEY"
          echo "FFMPEG OUTPUT: $FULL_URL"

          ffmpeg -re -stream_loop -1 \
            -i "$VIDEO" \
            -vcodec libx264 -preset veryfast -maxrate 3000k -bufsize 6000k \
            -pix_fmt yuv420p -g 50 \
            -c:a aac -b:a 128k -ar 44100 \
            -f flv "$FULL_URL"
