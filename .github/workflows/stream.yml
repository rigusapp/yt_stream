name: Stream to YouTube (FFmpeg)

on:
  workflow_dispatch:
    inputs:
      video_url:
        required: true
      start_time:
        required: true
      duration_seconds:
        required: true
      looping:
        required: false

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "Video: ${{ github.event.inputs.video_url }}"
          echo "Start: ${{ github.event.inputs.start_time }}"
          echo "Durasi: ${{ github.event.inputs.duration_seconds }}"
          echo "Looping: ${{ github.event.inputs.looping }}"

      - run: sudo apt-get update -y && sudo apt-get install -y ffmpeg

      - name: Wait until start time
        env:
          START_ISO: "${{ github.event.inputs.start_time }}"
        run: |
          start_epoch=$(date -d "$START_ISO" +%s)
          now_epoch=$(date +%s)
          wait_seconds=$((start_epoch - now_epoch))
          if [ $wait_seconds -gt 0 ]; then
            [ $wait_seconds -gt 21600 ] && wait_seconds=21600
            sleep $wait_seconds
          fi

      - name: Stream (with looping support)
        env:
          YTKEY: ${{ secrets.YT_STREAM_KEY }}
          VIDEO_URL: "${{ github.event.inputs.video_url }}"
          DURATION: "${{ github.event.inputs.duration_seconds }}"
          LOOPING: "${{ github.event.inputs.looping }}"
        run: |
          if [ "$LOOPING" = "true" ]; then
            end=$((SECONDS + DURATION))
            while [ $SECONDS -lt $end ]; do
              echo "Looping stream..."
              ffmpeg -re -i "$VIDEO_URL" -c:v libx264 -preset veryfast -b:v 2500k                 -c:a aac -b:a 128k -f flv "rtmp://a.rtmp.youtube.com/live2/$YTKEY"
              sleep 5
            done
          else
            ffmpeg -re -i "$VIDEO_URL" -c:v libx264 -preset veryfast -b:v 2500k               -c:a aac -b:a 128k -f flv "rtmp://a.rtmp.youtube.com/live2/$YTKEY" -t "$DURATION"
          fi
