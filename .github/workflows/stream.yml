name: Stream to YouTube (Auto Stop Duration)

on:
  repository_dispatch:
    types: [stream_trigger]

jobs:
  stream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Debug Payload
        run: |
          echo "VIDEO URL    : ${{ github.event.client_payload.video_url }}"
          echo "RTMP URL     : ${{ github.event.client_payload.rtmp_url }}"
          echo "STREAM KEY   : ${{ github.event.client_payload.stream_key }}"
          echo "DURATION SEC : ${{ github.event.client_payload.duration_seconds }}"

      - name: Stream to YouTube
        run: |
          VIDEO="${{ github.event.client_payload.video_url }}"
          RTMP="${{ github.event.client_payload.rtmp_url }}/${{ github.event.client_payload.stream_key }}"
          DURATION=${{ github.event.client_payload.duration_seconds }}

          echo "=== STARTING STREAM ==="
          echo "Video     : $VIDEO"
          echo "RTMP      : $RTMP"
          echo "Duration  : $DURATION seconds"
          echo "========================"

          # Jalankan FFmpeg dan hentikan otomatis berdasarkan durasi
          ffmpeg -re \
            -i "$VIDEO" \
            -t $DURATION \
            -c:v libx264 -preset veryfast -b:v 4500k \
            -c:a aac -b:a 128k \
            -f flv "$RTMP"

          echo "=== STREAM FINISHED ==="
